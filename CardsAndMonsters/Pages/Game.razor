@page "/play"
@layout EmptyLayout

@if (!GameEnded)
{
<div class="container-fluid">
    <div class="opponent-display">
        <div class="row">
            <div class="col-10">
                <PlayerHand Cards="Opponent.CurrentHand" HideInfo />
            </div>
            <div class="col-2">
                <h3 class="text-right">Opponent - @Opponent.HP</h3>
                <DeckPreview DeckCount="Opponent.Deck.Count" />
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-2">
            <h3 class="text-left">Turn: @(TurnCount + 1) (@CurrentTurn.Phase)</h3>
            @if (IsPlayerTurn())
            {
                <button class="btn" @onclick="() => EnterPhase(Phase.Battle)">BATTLE</button>
                <button class="btn" @onclick="EndTurn">END TURN</button>
            }
            else
            {
                <button class="btn" @onclick="EndTurn">END OPPONENTS TURN</button>
            }
        </div>
        <div class="col-9">
            <div class="board">
                <div class="opponent-cards">
                    <div class="spell-row">
                        @for (int i = 0; i < 5; i++)
                        {
                            <div class="card">
                                <p class="p-3">&nbsp;</p>
                            </div>
                        }
                    </div>
                    <div class="monster-row">
                        @foreach (var card in Board.OpponentMonsters)
                        {
                            <div class="card">
                                <p class="p-3">@card.Attack || @card.Defense</p>
                            </div>
                        }
                        @for (int i = 0; i < 5 - Board.OpponentMonsters.Count; i++)
                        {
                            <div class="card">
                                <p class="p-3">&nbsp;</p>
                            </div>
                        }
                    </div>
                </div>
                <div class="player-cards">
                    <div class="monster-row">
                        @foreach (var card in Board.PlayerMonsters)
                        {
                            <div class="card">
                                <p class="p-3">@card.Attack || @card.Defense</p>
                                @if (CurrentTurn.Phase is Phase.Battle && TurnCount > 0)
                                {
                                    <button @onclick="() => DirectAttack(card, Opponent)" class="btn btn-primary">ATTACK</button>
                                }
                            </div>
                        }
                        @for (int i = 0; i < 5 - Board.PlayerMonsters.Count; i++)
                        {
                            <div class="card">
                                <p class="p-3">&nbsp;</p>
                            </div>
                        }
                    </div>
                    <div class="spell-row">
                        @for (int i = 0; i < 5; i++)
                        {
                            <div class="card">
                                <p class="p-3">&nbsp;</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        <div class="col-1">
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="player-display">
        <div class="row">
            <div class="col-2">
                <h3 class="text-left">You - @Player.HP</h3>
                <DeckPreview DeckCount="Player.Deck.Count" />
            </div>
            <div class="col-10">
                <PlayerHand Cards="Player.CurrentHand" CanPlay="IsPlayerTurn() && TurnCount > 0" CardPlayed="PlayCard" Phase="CurrentTurn.Phase"/>
            </div>
        </div>
    </div>
</div>
}
else
{
    <h3 class="text-center">Game Over</h3>
}

@code {
    private Player Player;
    private Player Opponent;

    private Board Board;
    private IDictionary<int, TurnState> Turns;
    private TurnState CurrentTurn;

    private Player StartingPlayer;
    private bool ChoosingFieldPosition;
    private bool GameEnded;

    protected override async Task OnInitializedAsync()
    {
        Turns = new Dictionary<int, TurnState>();
        CurrentTurn = new();
        Board = new();

        Player = PlayerBuilder.GetNewPlayer();
        Opponent = PlayerBuilder.GetNewOpponent();

        Random rnd = new();
        StartingPlayer = rnd.Next(2) == 1 ? Opponent : Player;

        EnterPhase(Phase.Standby);
        StateHasChanged();

        for (int i = 0; i < 5; i++)
        {
            Opponent.DrawCard();
            Player.DrawCard();
            StateHasChanged();
            await Task.Delay(300);
        }

        EnterPhase(Phase.Main);
    }

    private int TurnCount = 0;
    private bool IsPlayerTurn()
    {
        var isStartingPlayersTurn = TurnCount % 2 == 0;
        return StartingPlayer.Equals(StartingPlayer, Player) ? isStartingPlayersTurn : !isStartingPlayersTurn;
    }

    private void StartTurn(Player player)
    {
        var success = player.DrawCard();

        if (!success)
        {
            EndGame();
        }

        EnterPhase(Phase.Main);
    }

    private void EnterPhase(Phase phase)
    {
        CurrentTurn.Phase = phase;
    }

    private void EndTurn()
    {
        EnterPhase(Phase.End);
        Turns[TurnCount] = CurrentTurn;
        CurrentTurn = new();
        TurnCount++;
        EnterPhase(Phase.Standby);
        StartTurn(IsPlayerTurn() ? Player : Opponent);
    }

    private void PlayCard(BaseCard card)
    {
        if (card.GetType() == typeof(Monster))
        {
            var monster = card as Monster;
            if (IsPlayerTurn())
            {
                if (Board.PlayerMonsters.Count == 5 || CurrentTurn.NormalSummonLimitReached())
                {
                    return;
                }

                CurrentTurn.NormalSummonedMonsters.Add(monster);
                Player.PlayMonster(monster, Board);
            }
            else
            {
                if (Board.OpponentMonsters.Count == 5 || CurrentTurn.NormalSummonLimitReached())
                {
                    return;
                }

                CurrentTurn.NormalSummonedMonsters.Add(monster);
                Opponent.PlayMonster(monster, Board);
            }
        }
    }

    private void DirectAttack(Monster monster, Player player)
    {
        var dmg = monster.Attack;
        if (player.Equals(Player))
        {
            DamagePlayer(dmg);
        }
        else
        {
            DamageOpponent(dmg);
        }
    }

    private void DamageOpponent(decimal amount)
    {
        Opponent.TakeDamage(amount);
        CheckForGameOver();
    }

    private void DamagePlayer(decimal amount)
    {
        Player.TakeDamage(amount);
        CheckForGameOver();
    }

    private void CheckForGameOver()
    {
        if (Player.OutOfHealth() || Opponent.OutOfHealth())
        {
            EndGame();
        }
    }

    private void EndGame()
    {
        GameEnded = true;
    }
}

<style>
    .opponent-display {
        margin-bottom: 1em;
    }
    .player-display {
        margin-top: 1em;
    }

    .spell-row, .monster-row {
        display: flex;
        justify-content: space-between;
    }
</style>